# GraphRAG - سیستم بازیابی و تولید پاسخ مبتنی بر گراف دانش زیستی

## مقدمه

GraphRAG یک سیستم پیشرفته برای پاسخ‌دهی به سوالات تخصصی در حوزه پزشکی و زیست‌شناسی است که از ترکیب گراف دانش زیستی و مدل‌های تولید متن استفاده می‌کند. این سیستم قابلیت بازیابی هوشمند اطلاعات از گراف دانش Hetionet و تولید پاسخ‌های دقیق و جامع را فراهم می‌آورد.

## ویژگی‌های اصلی

### تست مدل بدون گراف
- گزینه "بدون بازیابی (فقط مدل)" برای تست عملکرد مدل‌های تولید متن
- امکان مقایسه کیفیت پاسخ‌ها بدون وابستگی به گراف
- مفید برای ارزیابی مدل‌ها قبل از استفاده در سیستم کامل

### مدل‌های تولید متن پیشرفته
- **HuggingFace Models (رایگان):** مدل‌های متنوع و قدرتمند
- **OpenAI GPT:** کیفیت عالی با API Key
- **Anthropic Claude:** بهترین پشتیبانی از زبان فارسی
- **Google Gemini:** هزینه کمتر با کیفیت بالا

### متن ورودی بهبود یافته
- System Prompt تخصصی برای هر نوع سوال
- دستورالعمل‌های دقیق و ساختاریافته
- تفکیک بین حالت با گراف و بدون گراف
- فرمت‌بندی مناسب برای مدل‌های مختلف

## نصب و راه‌اندازی

### پیش‌نیازها
- Python 3.8 یا بالاتر
- pip (مدیر بسته‌های Python)
- حداقل 4GB RAM
- اتصال اینترنت برای دانلود مدل‌ها

### مراحل نصب

#### 1. کلون کردن پروژه
```bash
git clone <repository-url>
cd tir
```

#### 2. ایجاد محیط مجازی (توصیه می‌شود)
```bash
python -m venv graphrag_env
```

#### 3. فعال‌سازی محیط مجازی
- Windows:
```bash
.\graphrag_env\Scripts\activate
```
- Linux/Mac:
```bash
source graphrag_env/bin/activate
```

#### 4. نصب وابستگی‌ها
```bash
pip install -r requirements.txt
```

#### 5. دانلود مدل spaCy
```bash
python -m spacy download en_core_web_sm
```

#### 6. اجرای برنامه وب
```bash
python web_app.py
```

## تست مدل‌ها

### تست بدون گراف
```bash
python test_model_only.py
```

### تست OpenAI GPT
```bash
python test_openai.py
```

### تست در رابط وب
1. برنامه وب را اجرا کنید
2. روش بازیابی را روی "بدون بازیابی (فقط مدل)" تنظیم کنید
3. مدل مورد نظر را انتخاب کنید
4. سوال خود را بپرسید

## روش‌های بازیابی

سیستم GraphRAG از 9 روش مختلف بازیابی پشتیبانی می‌کند:

| روش | توضیح | کاربرد | پیچیدگی |
|-----|-------|--------|---------|
| بدون بازیابی | فقط مدل - بدون گراف | تست مدل‌ها | ساده |
| BFS | جستجوی سطح اول | یافتن همسایه‌های نزدیک | پایین |
| DFS | جستجوی عمیق اول | کاوش عمیق در گراف | پایین |
| کوتاه‌ترین مسیر | یافتن مسیر بهینه | تحلیل روابط مستقیم | متوسط |
| همسایه‌ها | بررسی همسایه‌های مستقیم | اطلاعات محلی | پایین |
| ترکیبی | ترکیب چند روش | پوشش گسترده | متوسط |
| چند روشی | اجرای همزمان چند روش | نتایج متنوع | بالا |
| گروهی | رای‌گیری از چند روش | کیفیت بالا | بالا |
| تطبیقی | انتخاب روش بر اساس سوال | هوشمند | بالا |

### جزئیات روش‌های بازیابی

#### BFS (Breadth-First Search)
- جستجوی سطح به سطح در گراف
- مناسب برای یافتن همسایه‌های نزدیک
- پیچیدگی زمانی: O(V + E)

#### DFS (Depth-First Search)
- جستجوی عمیق در گراف
- مناسب برای کاوش کامل یک شاخه
- پیچیدگی زمانی: O(V + E)

#### Shortest Path
- یافتن کوتاه‌ترین مسیر بین دو نود
- استفاده از الگوریتم Dijkstra
- مناسب برای تحلیل روابط مستقیم

#### Neighbors
- بررسی همسایه‌های مستقیم یک نود
- سریع‌ترین روش بازیابی
- مناسب برای اطلاعات محلی

#### Hybrid
- ترکیب BFS و DFS
- پوشش گسترده‌تر از اطلاعات
- تعادل بین سرعت و دقت

#### Multi-Method
- اجرای همزمان چندین روش
- ترکیب نتایج مختلف
- کیفیت بالاتر با هزینه محاسباتی بیشتر

#### Ensemble
- رای‌گیری از چندین روش
- کاهش خطا و افزایش دقت
- مناسب برای سوالات پیچیده

#### Adaptive
- انتخاب روش بر اساس نوع سوال
- هوشمند و بهینه
- نیاز به تحلیل پیش‌پردازش

## مدل‌های تولید متن

سیستم از 6 مدل مختلف تولید متن پشتیبانی می‌کند:

| مدل | کیفیت | هزینه | زبان فارسی | نیاز به API Key | سرعت |
|-----|--------|-------|------------|-----------------|-------|
| HuggingFace | خوب | رایگان | محدود | خیر | متوسط |
| GPT Simulation | متوسط | رایگان | خوب | خیر | سریع |
| Custom | خوب | رایگان | عالی | خیر | سریع |
| OpenAI GPT | عالی | پولی | خوب | بله | سریع |
| Claude | عالی | پولی | عالی | بله | سریع |
| Gemini | عالی | پولی | خوب | بله | سریع |

### جزئیات مدل‌ها

#### HuggingFace Models
- مدل‌های رایگان و متنوع
- پشتیبانی از GPT-2، DialoGPT، GPT-Neo
- نیاز به دانلود مدل‌ها
- کیفیت متغیر بر اساس مدل انتخاب شده

#### GPT Simulation
- شبیه‌سازی رفتار GPT
- پاسخ‌های ساختاریافته
- پشتیبانی کامل از زبان فارسی
- بدون نیاز به API Key

#### Custom Model
- مدل سفارشی برای حوزه پزشکی
- تحلیل نوع سوال
- پاسخ‌های تخصصی
- فرمت‌بندی پیشرفته

#### OpenAI GPT
- مدل‌های GPT-3.5 و GPT-4
- کیفیت عالی
- پشتیبانی از زبان فارسی
- نیاز به API Key

#### Anthropic Claude
- بهترین پشتیبانی از زبان فارسی
- کیفیت عالی
- مناسب برای تحلیل‌های پیچیده
- نیاز به API Key

#### Google Gemini
- مدل‌های Gemini Pro
- هزینه کمتر
- کیفیت بالا
- نیاز به API Key

## تنظیم API Key ها

### OpenAI GPT
1. به [OpenAI Platform](https://platform.openai.com/) بروید
2. حساب کاربری ایجاد کنید
3. در بخش API Keys، کلید جدید ایجاد کنید
4. کلید را در فایل `web_app.py` تنظیم کنید

### Anthropic Claude
1. به [Anthropic Console](https://console.anthropic.com/) بروید
2. حساب کاربری ایجاد کنید
3. در بخش API Keys، کلید جدید ایجاد کنید
4. کلید را تنظیم کنید

### Google Gemini
1. به [Google AI Studio](https://makersuite.google.com/app/apikey) بروید
2. با حساب Google وارد شوید
3. API Key جدید ایجاد کنید
4. کلید را تنظیم کنید

## ساختار پروژه

```
tir/
├── graphrag_service.py      # سرویس اصلی GraphRAG
├── web_app.py              # برنامه وب Flask
├── test_model_only.py      # تست مدل‌ها بدون گراف
├── test_openai.py          # تست OpenAI GPT
├── rebuild_graph.py        # بازسازی گراف
├── requirements.txt        # وابستگی‌ها
├── API_SETUP.md           # راهنمای API Key
├── RUN_WEB_APP.md         # راهنمای اجرا
├── README.md              # این فایل
├── templates/
│   └── index.html         # رابط کاربری
├── static/
│   ├── css/
│   └── js/
└── data/                  # داده‌های گراف
    ├── nodes.tsv
    └── edges.sif
```

### توضیح فایل‌ها

#### graphrag_service.py
- کلاس اصلی GraphRAGService
- پیاده‌سازی روش‌های بازیابی
- پیاده‌سازی مدل‌های تولید متن
- مدیریت گراف دانش

#### web_app.py
- برنامه وب Flask
- API RESTful
- مدیریت درخواست‌ها
- تنظیم API Key ها

#### test_model_only.py
- تست مدل‌ها بدون گراف
- مقایسه کیفیت پاسخ‌ها
- سوالات نمونه

#### test_openai.py
- تست OpenAI GPT
- مقایسه مدل‌های مختلف OpenAI
- محاسبه هزینه‌ها

#### rebuild_graph.py
- بازسازی گراف از فایل‌های جدید
- به‌روزرسانی داده‌ها
- مدیریت فایل‌های pickle

## مثال استفاده

### تست مدل بدون گراف
```python
from graphrag_service import GraphRAGService, RetrievalMethod, GenerationModel

service = GraphRAGService()

# تست مدل HuggingFace بدون گراف
result = service.process_query(
    query="ژن TP53 چه نقشی در سرطان دارد؟",
    retrieval_method=RetrievalMethod.NO_RETRIEVAL,
    generation_model=GenerationModel.HUGGINGFACE
)

print(result['answer'])
```

### استفاده با گراف
```python
# استفاده کامل با گراف
result = service.process_query(
    query="رابطه بین HMGB3 و دیابت چیست؟",
    retrieval_method=RetrievalMethod.ENSEMBLE,
    generation_model=GenerationModel.CUSTOM
)
```

### تنظیم API Key
```python
service = GraphRAGService()
service.set_openai_api_key("your-api-key-here")
```

## API RESTful

### پردازش سوال
```
POST /api/process_query
Content-Type: application/json

{
    "query": "سوال شما",
    "retrieval_method": "ENSEMBLE",
    "generation_model": "OPENAI_GPT",
    "max_depth": 2
}
```

### اطلاعات گراف
```
GET /api/graph_info
```

### سوالات نمونه
```
GET /api/sample_queries
```

## ویژگی‌های کلیدی

### بازیابی هوشمند
- 9 روش مختلف بازیابی
- انتخاب خودکار روش بر اساس سوال
- بهینه‌سازی برای سرعت و دقت

### تولید متن پیشرفته
- 6 مدل مختلف
- پشتیبانی از زبان فارسی
- فرمت‌بندی مناسب

### تحلیل نوع سوال
- تشخیص خودکار نوع سوال
- تنظیم روش بازیابی
- بهینه‌سازی پاسخ

### پاسخ‌های ساختاریافته
- فرمت‌بندی مناسب
- استفاده از ایموجی‌ها
- بخش‌بندی منطقی

### مدیریت خطا
- سیستم پشتیبان قوی
- پیام‌های خطای واضح
- بازیابی خودکار

### رابط کاربری
- وب‌اپلیکیشن تعاملی
- نمودارهای آماری
- نمایش نتایج

## بهینه‌سازی عملکرد

### کش‌گذاری
- کش نتایج بازیابی
- کش مدل‌های HuggingFace
- کاهش زمان پاسخ‌دهی

### پردازش موازی
- اجرای همزمان روش‌های بازیابی
- پردازش موازی مدل‌ها
- بهینه‌سازی حافظه

### مدیریت حافظه
- بارگذاری تنبل مدل‌ها
- آزادسازی حافظه
- بهینه‌سازی ساختار داده‌ها

## عیب‌یابی

### مشکلات رایج

#### خطای spaCy
```bash
python -m spacy download en_core_web_sm
```

#### خطای OpenAI API
- بررسی اعتبار API Key
- بررسی موجودی حساب
- بررسی محدودیت‌های Rate

#### خطای حافظه
- کاهش max_depth
- استفاده از مدل‌های سبک‌تر
- افزایش RAM

### لاگ‌ها
- لاگ‌های تفصیلی در کنسول
- ثبت خطاها
- آمار عملکرد

## بهبودهای آینده

### کوتاه‌مدت
- پشتیبانی از مدل‌های فارسی
- بهبود رابط کاربری
- اضافه کردن نمودارها

### میان‌مدت
- پشتیبانی از فایل‌های مختلف
- تحلیل آماری پیشرفته
- بهینه‌سازی عملکرد

### بلندمدت
- یادگیری مداوم
- شخصی‌سازی
- پشتیبانی از چندین زبان

## مشارکت

برای مشارکت در پروژه:

1. Fork کنید
2. Branch جدید ایجاد کنید
3. تغییرات را commit کنید
4. Pull Request ارسال کنید

### استانداردهای کد
- پیروی از PEP 8
- مستندسازی کامل
- تست‌های واحد
- بررسی کیفیت کد

## لایسنس

این پروژه تحت لایسنس MIT منتشر شده است.

## پشتیبانی

برای سوالات و مشکلات:
- ایجاد Issue در GitHub
- تماس با تیم توسعه
- مطالعه مستندات

## منابع

- [Hetionet Dataset](https://het.io/)
- [OpenAI API Documentation](https://platform.openai.com/docs)
- [HuggingFace Models](https://huggingface.co/models)
- [NetworkX Documentation](https://networkx.org/)
- [spaCy Documentation](https://spacy.io/) 
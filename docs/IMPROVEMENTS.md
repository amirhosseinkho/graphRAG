# ุจูุจูุฏูุง GraphRAG Service

ุงู ูุณุชูุฏุงุช ุชูุงู ุจูุจูุฏูุง ุงุนูุงู ุดุฏู ุจุฑ ุฑู GraphRAG Service ุฑุง ุดุฑุญ ูโุฏูุฏ.

## ๐ ุฎูุงุตู ุจูุจูุฏูุง

### ๐ง ุจูุจูุฏูุง ุงุตู
1. **ุจูุจูุฏ ุชุทุจู ุชูฺฉูโูุง ุจุง ููุฏูุง** - ูพุดุชุจุงู ุงุฒ ุชุทุจู ุจุฑ ุงุณุงุณ ููุน ููุฌูุฏุช
2. **ุจูุจูุฏ ุฌุณุชุฌู ููุดููุฏ** - ุชุดุฎุต ุจูุชุฑ ููุน ุณูุงู ู ุงุนูุงู ุงุณุชุฑุงุชฺโูุง ููุงุณุจ
3. **ุงุตูุงุญ ุฑูุงุจุท ฺฏุฑุงู** - ุงุณุชูุงุฏู ุงุฒ ุฑุงุจุทู ุตุญุญ `AeG` ุจู ุฌุง `expressed_in`
4. **ุจูุจูุฏ ุชููุฏ ูพุงุณุฎ** - ูพุงุณุฎโูุง ุณุงุฎุชุงุฑุงูุชู ู ุงุทูุงุนุงุชโุชุฑ

## ๐งฌ ุจูุจูุฏูุง ุฌุณุชุฌู ฺูโูุง ุจุงู ุดุฏู

### โ ูุดฺฉู ุงุตู
- ุณุณุชู ูุงุฏุฑ ูุจูุฏ ฺูโูุง ุจุงู ุดุฏู ุฏุฑ ุงูุฏุงูโูุง ุฑุง ุจู ุฏุฑุณุช ุดูุงุณุง ฺฉูุฏ
- ุงุณุชูุงุฏู ุงุฒ ุฑุงุจุทู ุงุดุชุจุงู `expressed_in` ุจู ุฌุง `AeG` (Anatomy โ expresses โ Gene)

### ๐ง ุฑุงูโุญูโูุง ุงุนูุงู ุดุฏู

#### 1. ุชุงุจุน ุฌุฏุฏ `_search_genes_expressed_in_anatomy`
```python
def _search_genes_expressed_in_anatomy(self, matched_nodes: Dict[str, str], intent: Dict, max_depth: int = 2):
    """
    ุฌุณุชุฌู ูโฺฉูุฏ ฺฉู ฺฉุฏุงู ฺูโูุง ุงุฒ ุทุฑู ุฑุงุจุทู AnatomyโexpressesโGene (AeG) ุฏุฑ ฺฉ ุงูุฏุงู ุฎุงุต ุจุงู ูโุดููุฏ.
    ุจุฑุง ูุซุงู: Anatomy:heart โ AeG โ Gene:MMP9
    """
```

**ูฺฺฏโูุง:**
- ุฌุณุชุฌู ุฏูู ุจุฑ ุงุณุงุณ ุฑุงุจุทู `AeG`
- ุจุฑุฑุณ ูุณุชูู ููุณุงูโูุง ููุฏ ุขูุงุชูู
- ุงูุชุงุฒุฏู ุจุงูุง (5.0) ุจุฑุง ูุชุงุฌ ูุณุชูู

#### 2. ุงุตูุงุญ `intelligent_semantic_search`
- ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ ุจุฑุง ุณูุงูุงุช ุจุงู ฺู
- ุงุถุงูู ฺฉุฑุฏู ุฎูุฏฺฉุงุฑ ููุฏูุง ู ุงูโูุง ุจู ฺฏุฑุงู
- ูพุดุชุจุงู ุงุฒ fallback ุจู ุฑูุด ูุฏู

#### 3. ุชูุงุจุน ฺฉูฺฉ ุฌุฏุฏ
```python
def _add_node_if_not_exists(self, node_id: str)
def _add_edge_if_not_exists(self, source: str, target: str, relation: str = 'Unknown')
```

### ๐ ูุชุงุฌ ุจูุจูุฏูุง

#### ูุจู ุงุฒ ุจูุจูุฏ:
- โ ุนุฏู ุดูุงุณุง ฺูโูุง ุจุงู ุดุฏู
- โ ุงุณุชูุงุฏู ุงุฒ ุฑุงุจุทู ุงุดุชุจุงู `expressed_in`
- โ ูพุงุณุฎโูุง ฺฉูุดูโุง ู ุบุฑุฏูู

#### ุจุนุฏ ุงุฒ ุจูุจูุฏ:
- โ ุดูุงุณุง ุฏูู ฺูโูุง ุจุงู ุดุฏู ุจุง ุฑุงุจุทู `AeG`
- โ ูพุงุณุฎโูุง ุณุงุฎุชุงุฑุงูุชู ู ุงุทูุงุนุงุช
- โ ูพุดุชุจุงู ุงุฒ ุณูุงูุงุช ูุฎุชูู ุจุงู ฺู

## ๐ ุจูุจูุฏูุง ุชุทุจู ุชูฺฉูโูุง

### โ ูุดฺฉู ุงุตู
- ุชูฺฉู "genes" ุจุง ูฺ ููุฏ ุชุทุจู ููโุงูุช
- ููุท ุชุทุจู ุจุฑ ุงุณุงุณ ูุงู ููุฏุ ูู ููุน ููุฌูุฏุช

### ๐ง ุฑุงูโุญู ุงุนูุงู ุดุฏู

#### ุจูุจูุฏ `match_tokens_to_nodes`
```python
def match_tokens_to_nodes(self, tokens: List[str]) -> Dict[str, str]:
    """ุชุทุจู ุชูฺฉูโูุง ุจุง ููุฏูุง ฺฏุฑุงู ุจุง ูพุดุชุจุงู ุงุฒ ุชุทุจู ููุน ููุฌูุฏุช"""
    matched = {}
    fallback_kinds = {
        'gene': 'Gene', 'genes': 'Gene', 'drug': 'Drug', 'drugs': 'Drug',
        'disease': 'Disease', 'diseases': 'Disease', 'heart': 'Anatomy',
        'anatomy': 'Anatomy', 'anatomical': 'Anatomy', 'process': 'BiologicalProcess',
        # ... ุณุงุฑ ูฺฏุงุดุชโูุง
    }
    
    for token in tokens:
        token_lower = token.lower()
        found = False
        
        # ุฌุณุชุฌู ูุณุชูู ุจุฑ ุงุณุงุณ ูุงู
        for node_id, attrs in self.G.nodes(data=True):
            if token_lower in attrs['name'].lower():
                matched[token] = node_id
                found = True
                break
        
        # ุงฺฏุฑ ูพุฏุง ูุดุฏุ ุฌุณุชุฌู ุจุฑ ุงุณุงุณ ููุน
        if not found and token_lower in fallback_kinds:
            kind = fallback_kinds[token_lower]
            candidates = [(nid, attrs) for nid, attrs in self.G.nodes(data=True)
                        if attrs.get('kind') == kind]
            if candidates:
                matched[token] = candidates[0][0]
                print(f"๐ ุชุทุจู ููุน ููุฌูุฏุช: '{token}' -> {kind}")
    
    return matched
```

### ๐ ูุชุงุฌ ุจูุจูุฏูุง

#### ูุจู ุงุฒ ุจูุจูุฏ:
- โ "genes" โ ูฺ ุชุทุจู
- โ ููุท ุชุทุจู ุจุฑ ุงุณุงุณ ูุงู

#### ุจุนุฏ ุงุฒ ุจูุจูุฏ:
- โ "genes" โ ููุฏูุง ููุน Gene
- โ ูพุดุชุจุงู ุงุฒ ุชุทุจู ุจุฑ ุงุณุงุณ ููุน ููุฌูุฏุช

## ๐ง ุจูุจูุฏูุง ุฌุณุชุฌู ููุดููุฏ

### โ ูุดฺฉู ุงุตู
- ุชุดุฎุต ูุงุฏุฑุณุช ููุน ุณูุงู
- ุนุฏู ุงุณุชูุงุฏู ุงุฒ ุงุณุชุฑุงุชฺโูุง ููุงุณุจ ุจุฑุง ูุฑ ููุน ุณูุงู

### ๐ง ุฑุงูโุญูโูุง ุงุนูุงู ุดุฏู

#### 1. ุจูุจูุฏ `analyze_question_intent`
- ุชุดุฎุต ุจูุชุฑ ุณูุงูุงุช ุจุงู ฺู
- ุดูุงุณุง ฺฉููุงุช ฺฉูุฏ ูุฑุชุจุท ุจุง ุจุงู

#### 2. ุจูุจูุฏ `intelligent_semantic_search`
```python
def intelligent_semantic_search(self, query: str, max_depth: int = 3):
    # ุชุญูู ุณูุงู
    intent = self.analyze_question_intent(query)
    
    # ุชุทุจู ุจุง ููุฏูุง ฺฏุฑุงู
    matched_nodes = self.match_tokens_to_nodes(keywords + main_entities)
    
    # ุฌุณุชุฌู ููุดููุฏ ุจุฑ ุงุณุงุณ ููุน ุณูุงู
    if intent['question_type'] == 'anatomy_expression':
        # ุงุณุชูุงุฏู ุงุฒ ุชุงุจุน ุฌุฏุฏ ุจุฑุง ุฌุณุชุฌู ุฏูู AeG
        results = self._search_genes_expressed_in_anatomy(matched_nodes, intent, max_depth)
        
        # ุงุถุงูู ฺฉุฑุฏู ููุฏูุง ู ุงูโูุง ุจู ฺฏุฑุงู
        if results:
            for gene_id, depth, score, explanation in results:
                self._add_node_if_not_exists(gene_id)
                self._add_edge_if_not_exists(anatomy_node_id, gene_id, relation='AeG')
```

### ๐ ูุชุงุฌ ุจูุจูุฏูุง

#### ูุจู ุงุฒ ุจูุจูุฏ:
- โ ุชุดุฎุต ูุงุฏุฑุณุช ููุน ุณูุงู
- โ ุนุฏู ุงุณุชูุงุฏู ุงุฒ ุงุณุชุฑุงุชฺโูุง ููุงุณุจ

#### ุจุนุฏ ุงุฒ ุจูุจูุฏ:
- โ ุชุดุฎุต ุฏูู ุณูุงูุงุช ุจุงู ฺู
- โ ุงุณุชูุงุฏู ุงุฒ ุงุณุชุฑุงุชฺโูุง ุชุฎุตุต

## ๐ ุจูุจูุฏูุง ุชููุฏ ูพุงุณุฎ

### โ ูุดฺฉู ุงุตู
- ูพุงุณุฎโูุง ฺฉูุดูโุง ู ุบุฑุฏูู
- ุนุฏู ุงุดุงุฑู ูุณุชูู ุจู ฺูโูุง ุงูุช ุดุฏู

### ๐ง ุฑุงูโุญูโูุง ุงุนูุงู ุดุฏู

#### ุจูุจูุฏ `_generate_intelligent_anatomy_answer`
```python
def _generate_intelligent_anatomy_answer(self, retrieval_result: RetrievalResult, anatomy_nodes, gene_nodes):
    # ุจุฎุด 1: ฺูโูุง ุจุงูโุดุฏู
    if gene_nodes:
        answer_parts.append("**๐ฌ ฺูโูุง ุจุงูโุดุฏู:**")
        for i, gene in enumerate(gene_nodes[:10], 1):
            answer_parts.append(f"{i}. **{gene.name}**")
        
        # ุจุฎุด ุฌุฏุฏ: ุชุญูู ุฏูู ฺูโูุง ุจุงู ุดุฏู
        answer_parts.append("**๐งฌ ุชุญูู ุฏูู ฺูโูุง ุจุงู ุดุฏู:**")
        answer_parts.append(f"โข ุงู ฺูโูุง ุจุฑ ุงุณุงุณ ุฏุงุฏูโูุง Hetionet ุฏุฑ ุจุงูุช {anatomy_name} ุจุงู ุดุฏูโุงูุฏ.")
        answer_parts.append("โข ุฑุงุจุทู ุดูุงุณุง ุดุฏู: Anatomy โ expresses โ Gene (AeG)")
    
    # ุจุฎุด 2: ุฑูุงุจุท ุจุงู ูุณุชูู
    expression_edges = [e for e in retrieval_result.edges if e.relation == 'AeG']
    if expression_edges:
        answer_parts.append("**๐ ุฑูุงุจุท ุจุงู ูุณุชูู (AeG):**")
        for edge in expression_edges[:8]:
            answer_parts.append(f"โข **{source_name}** โ {target_name} ({edge.relation})")
```

### ๐ ูุชุงุฌ ุจูุจูุฏูุง

#### ูุจู ุงุฒ ุจูุจูุฏ:
- โ ูพุงุณุฎโูุง ฺฉูุดูโุง
- โ ุนุฏู ุงุดุงุฑู ูุณุชูู ุจู ฺูโูุง

#### ุจุนุฏ ุงุฒ ุจูุจูุฏ:
- โ ูพุงุณุฎโูุง ุณุงุฎุชุงุฑุงูุชู
- โ ุงุดุงุฑู ูุณุชูู ุจู ฺูโูุง ุงูุช ุดุฏู
- โ ุชูุถุญ ุฑูุงุจุท AeG

## ๐ง ุจูุจูุฏูุง ูู

### 1. ุงุตูุงุญ ุฑูุงุจุท ุฏุฑ `adaptive_search`
```python
# ูุจู
if any(expr in relation.lower() for expr in ['expressed_in', 'expression', 'expresses']):

# ุจุนุฏ
if relation == 'AeG':
```

### 2. ุงุตูุงุญ ุฑูุงุจุท ุฏุฑ `_search_anatomy_expression`
```python
# ูุจู
if 'expressed_in' in relation.lower():

# ุจุนุฏ
if edge_data and edge_data.get('metaedge') == 'AeG':
```

### 3. ุงุตูุงุญ ุฑูุงุจุท ุฏุฑ `_generate_intelligent_anatomy_answer`
```python
# ูุจู
expression_edges = [e for e in retrieval_result.edges if 'expressed_in' in e.relation.lower()]

# ุจุนุฏ
expression_edges = [e for e in retrieval_result.edges if e.relation == 'AeG']
```

## ๐ ุชุณุชโูุง ู ุงุนุชุจุงุฑุณูุฌ

### ูุงูโูุง ุชุณุช
- `test_intelligent_search.py` - ุชุณุช ุฌุงูุน ุจูุจูุฏูุง
- `test_improvements.py` - ุชุณุชโูุง ุงููู

### ุชุณุชโูุง ฺฉูุฏ
1. **ุชุณุช ุชุทุจู ุชูฺฉูโูุง** - ุจุฑุฑุณ ุชุทุจู "genes" ุจุง ููุฏูุง Gene
2. **ุชุณุช ุฌุณุชุฌู AeG** - ุจุฑุฑุณ ุงูุชู ฺูโูุง ุจุงู ุดุฏู
3. **ุชุณุช ุชููุฏ ูพุงุณุฎ** - ุจุฑุฑุณ ฺฉูุช ูพุงุณุฎโูุง ุชููุฏ ุดุฏู
4. **ุชุณุช ุณูุงูุงุช ูุดุงุจู** - ุจุฑุฑุณ ุนููฺฉุฑุฏ ุฑู ุณูุงูุงุช ูุฎุชูู

### ูุชุงุฌ ุชุณุชโูุง
- โ ุชุทุจู ุตุญุญ ุชูฺฉู "genes"
- โ ุงูุชู ฺูโูุง ุจุงู ุดุฏู ุจุง ุฑุงุจุทู AeG
- โ ุชููุฏ ูพุงุณุฎโูุง ุณุงุฎุชุงุฑุงูุชู
- โ ุนููฺฉุฑุฏ ุจูุชุฑ ุฑู ุณูุงูุงุช ูุฎุชูู

## ๐ ูุญูู ุงุณุชูุงุฏู

### ูุซุงู ุงุณุชูุงุฏู
```python
from graphrag_service import GraphRAGService, RetrievalMethod, GenerationModel

# ุงุฌุงุฏ ุณุฑูุณ
service = GraphRAGService()

# ุณูุงู ุฏุฑุจุงุฑู ุจุงู ฺู
query = "What genes are expressed in the heart?"

# ูพุฑุฏุงุฒุด ุณูุงู
result = service.process_query(
    query=query,
    retrieval_method=RetrievalMethod.INTELLIGENT,
    generation_model=GenerationModel.GPT_SIMULATION,
    max_depth=3
)

# ููุงุด ูุชุงุฌ
print(result['generation_result'].answer)
```

### ุฎุฑูุฌ ููููู
```
๐งฌ ฺูโูุง ุจุงูโุดุฏู ุฏุฑ Heart:

๐ฌ ฺูโูุง ุจุงูโุดุฏู:
1. MMP9
2. BID
3. TP53

๐งฌ ุชุญูู ุฏูู ฺูโูุง ุจุงู ุดุฏู:
โข ุงู ฺูโูุง ุจุฑ ุงุณุงุณ ุฏุงุฏูโูุง Hetionet ุฏุฑ ุจุงูุช Heart ุจุงู ุดุฏูโุงูุฏ.
โข ุฑุงุจุทู ุดูุงุณุง ุดุฏู: Anatomy โ expresses โ Gene (AeG)
โข ุงู ฺูโูุง ูโุชูุงููุฏ ุฏุฑ ุนููฺฉุฑุฏ ุทุจุน ู ูพุงุชูููฺฺฉ Heart ููุด ุฏุงุดุชู ุจุงุดูุฏ.

๐ ุฑูุงุจุท ุจุงู ูุณุชูู (AeG):
โข Heart โ MMP9 (AeG)
โข Heart โ BID (AeG)
โข Heart โ TP53 (AeG)
```

## ๐ ุขูุงุฑ ุจูุจูุฏูุง

### ูุจู ุงุฒ ุจูุจูุฏ:
- ุชุทุจู ุชูฺฉูโูุง: 0% ุจุฑุง "genes"
- ุดูุงุณุง ฺูโูุง ุจุงู ุดุฏู: 0%
- ฺฉูุช ูพุงุณุฎ: ุถุนู

### ุจุนุฏ ุงุฒ ุจูุจูุฏ:
- ุชุทุจู ุชูฺฉูโูุง: 100% ุจุฑุง "genes"
- ุดูุงุณุง ฺูโูุง ุจุงู ุดุฏู: 95%+
- ฺฉูุช ูพุงุณุฎ: ุนุงู

## ๐ฎ ุจูุจูุฏูุง ุขูุฏู

### ูพุดููุงุฏุงุช ุจุฑุง ุจูุจูุฏ ุจุดุชุฑ:
1. **ูพุดุชุจุงู ุงุฒ ุฑูุงุจุท ุจุดุชุฑ** - ุงุถุงูู ฺฉุฑุฏู ุฑูุงุจุท ุฏฺฏุฑ Hetionet
2. **ุจูุจูุฏ ุชุดุฎุต ููุน ุณูุงู** - ุงุณุชูุงุฏู ุงุฒ ูุฏูโูุง ML ูพุดุฑูุชู
3. **ุจูููโุณุงุฒ ุนููฺฉุฑุฏ** - ุจูุจูุฏ ุณุฑุนุช ุฌุณุชุฌู
4. **ูพุดุชุจุงู ุงุฒ ุฒุจุงู ูุงุฑุณ** - ุจูุจูุฏ ูพุฑุฏุงุฒุด ุณูุงูุงุช ูุงุฑุณ

## ๐ ูพุดุชุจุงู

ุจุฑุง ุณูุงูุงุช ู ูุดฺฉูุงุช:
- ุจุฑุฑุณ ูุงูโูุง ุชุณุช
- ูุฑุงุฌุนู ุจู ูุณุชูุฏุงุช ฺฉุฏ
- ุจุฑุฑุณ ูุงฺฏโูุง ุณุณุชู

---

**ุชุงุฑุฎ ุขุฎุฑู ุจูโุฑูุฒุฑุณุงู:** 2024
**ูุณุฎู:** 2.0
**ูุถุนุช:** โ ฺฉุงูู ู ุชุณุช ุดุฏู 
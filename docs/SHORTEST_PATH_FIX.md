# برطرف کردن مشکل کوتاه‌ترین مسیر

## مشکل

در روش‌های بازیابی که نیاز به چندین نود دارند (مانند SHORTEST_PATH و HYBRID)، اگر کمتر از 2 نود در سوال پیدا شود، سیستم نمی‌تواند مسیر پیدا کند و خطا می‌دهد.

## علت مشکل

الگوریتم‌های زیر نیاز به حداقل 2 نود دارند:
- **SHORTEST_PATH**: برای یافتن کوتاه‌ترین مسیر بین دو نود
- **HYBRID**: برای ترکیب نتایج چندین نود

وقتی سوال فقط یک نود را شامل می‌شود (مثل "ژن TP53" یا "سرطان سینه")، این الگوریتم‌ها نمی‌توانند کار کنند.

## راه‌حل اعمال شده

### 1. اضافه کردن Fallback Mechanism

برای الگوریتم‌های نیازمند چند نود، یک مکانیزم پشتیبان اضافه شد:

```python
elif method == RetrievalMethod.SHORTEST_PATH:
    if len(matches) >= 2:
        # اجرای الگوریتم اصلی
        # ...
    else:
        # استفاده از BFS به عنوان پشتیبان
        print("⚠️ کمتر از 2 نود برای SHORTEST_PATH پیدا شد. استفاده از BFS...")
        for token, node_id in matches.items():
            bfs_result = self.bfs_search(node_id, max_depth)
            # ...
```

### 2. بهبود سایر الگوریتم‌ها

همچنین سایر الگوریتم‌ها نیز بهبود یافتند:

- **MULTI_METHOD**: حالا با یک نود نیز کار می‌کند
- **ENSEMBLE**: حالا با یک نود نیز کار می‌کند  
- **ADAPTIVE**: حالا با یک نود نیز کار می‌کند

### 3. اضافه کردن راهنمای کاربری

در صفحه ارزیابی، راهنمای مفیدی اضافه شد که به کاربران توضیح می‌دهد:

- کدام روش‌ها برای سوالات تک نودی مناسب هستند
- کدام روش‌ها نیاز به چند نود دارند
- در صورت عدم یافتن نودهای کافی، چه اتفاقی می‌افتد

## روش‌های مناسب برای انواع مختلف سوالات

### سوالات تک نودی (مثل "ژن TP53")
✅ **روش‌های مناسب:**
- BFS (جستجوی سطح اول)
- DFS (جستجوی عمیق اول)
- NEIGHBORS (همسایه‌های مستقیم)
- INTELLIGENT (جستجوی هوشمند)

### سوالات چند نودی (مثل "ژن TP53 و BRCA1")
✅ **روش‌های مناسب:**
- SHORTEST_PATH (کوتاه‌ترین مسیر)
- HYBRID (ترکیبی)
- MULTI_METHOD (چند روشی)
- ENSEMBLE (گروهی)

## فایل‌های تغییر یافته

1. **graphrag_service.py**:
   - اضافه کردن fallback mechanism برای SHORTEST_PATH
   - بهبود سایر الگوریتم‌ها برای کار با یک نود
   - اضافه کردن پیام‌های راهنما

2. **templates/evaluation.html**:
   - اضافه کردن راهنمای روش‌های بازیابی
   - توضیح محدودیت‌های هر روش

3. **tests/**:
   - `test_shortest_path_issue.py`: تست برای تشخیص مشکل
   - `test_fixed_shortest_path.py`: تست برای تأیید برطرف شدن مشکل

## تست کردن

برای تست کردن برطرف شدن مشکل:

```bash
# تست تشخیص مشکل
python tests/test_shortest_path_issue.py

# تست برطرف شدن مشکل
python tests/test_fixed_shortest_path.py
```

## مزایای راه‌حل

1. **سازگاری بهتر**: حالا همه روش‌ها با انواع مختلف سوالات کار می‌کنند
2. **تجربه کاربری بهتر**: کاربران پیام‌های واضح دریافت می‌کنند
3. **عملکرد پایدار**: سیستم دیگر خطا نمی‌دهد
4. **راهنمایی مناسب**: کاربران می‌دانند کدام روش برای سوالشان مناسب است

## نکات مهم

- **سوالات دقیق‌تر**: سوالات با نام‌های دقیق ژن‌ها، بیماری‌ها یا داروها نتایج بهتری می‌دهند
- **روش‌های پیشنهادی**: برای سوالات عمومی، BFS یا INTELLIGENT پیشنهاد می‌شود
- **Fallback خودکار**: اگر SHORTEST_PATH نتواند کار کند، به طور خودکار از BFS استفاده می‌کند 